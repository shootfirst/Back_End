# 消息队列

## 基本概念

+ 异步解耦

+ 削峰填谷

## Kafka


#### 名词概念

##### 角色

+ producer

+ consumer

+ broker

##### 过程流转

+ topic

+ partition




#### 索引

每一个partition会被分为多个segment，每当条件满足（时间和partition大小），将会创建新的segment

每个segment对应三个文件：

+ log：消息

+ index：offset - position

+ timeindex：timesnap - offset

[索引的冷区与热区](https://www.modb.pro/db/88205)


#### 发送消息

##### ack策略

##### 同步与异步

##### 幂等性设置

##### 事务设置


#### 高可用

##### 副本

+ replica

+ AR(Assigned replica)

+ ISR(in sync replica)

+ OSR(out of sync replica)

follower默认每隔500ms向leader fetch一次数据，只要一个Follower副本落后Leader副本的时间不连续超过10秒，则为IR

当leader死了，选举IR之一为leader（OSR通过参数配置后也可以）

##### 主从一致

+ HW(high watermark)

+ LEO(log end offset)

+ Leader HW：min（所有副本LEO），为此Leader副本不仅要保存自己的HW和LEO，还要保存follower副本的HW和LEO，而follower副本只需保存自己的HW和LEO

+ Follower HW：min(follower自身LEO，leader HW)

leader epoch：同raft任期


#### 消费消息

##### 自动提交与手动提交


#### 负载均衡


#### kafka高性能

+ 异步发送

+ 批量发送

+ pagecache

+ 追加写

+ 网络持久化到磁盘（mmap）

+ 磁盘发网络（sendfile）

+ mmap加速索引

+ 稀疏索引和相对位移

+ 多reactor多线程网络模型

+ topic，partition






