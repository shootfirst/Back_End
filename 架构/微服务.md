# 微服务

以专注于单一责任与功能的小型功能区块 (Small Building Blocks) 为基础，利用模块化的方式组合出复杂的大型应用程序，各功能区块使用与语言无关

不同的微服务之间，通过`RPC`来进行通信。

为了降低团队之间的沟通成本，每个微服务会提供一份 IDL（Interface Description Language）来描述自身提供的服务能力

为了保证应用稳定性，微服务架构会让每个微服务会以多副本的形式，容器的形态，部署在云计算中心。副本的数量是弹性的，这可以方便微服务根据请求的压力状况进行扩容和缩容。

为了加快新功能的迭代速度，每个微服务的生命周期都是独立的，它们可以独立地升级、回滚，这给微服务提供了非凡的灵活性。

## 微服务框架

微服务框架一般包含RPC框架，同时还包含其他微服务治理相关（其实rpc框架可以等同于微服务框架）

KiteX

## 微服务治理

### 路由

#### 服务注册与发现

如何才能把请求发往同数据中心的几个账户服务呢？ 这里必然需要一个注册中心提供名字服务，以便请求方进行服务方的寻址。

##### 注册

服务启动时，要将服务名称、IP地址、端口以及集群、权重等服务元信息注册到注册中心。

微服务在成功启动后，会主动发起服务注册，上报注册相关的信息，包括服务名、主机、端口等必选标签，以及实例权重、集群、泳道等可选标签。收到注册并验证无误后，注册中心会回复一个成功的信号，至此注册就完成了。

常见注册中心：consul，zookeeper，etcd

##### 健康检查

注册中心使用健康检查机制，在服务无法正常提供服务的时候尽快将实例从注册中心剔除。

心跳检测、进程状态探测

##### 服务发现

请求方可以提供目标服务的名称和若干元信息（机房、集群等），采取定期拉取或者订阅的模式从注册中心获得最新的注册列表。

当带 ? 的评论服务需要访问账户服务的时候，它会先向注册中心发送一个 lookup 请求，表明它想要访问 account 账户服务。注册中心接收到请求之后，会把符合条件的实例列表返回



#### 负载均衡

+ 轮转调度

+ 随机调度

+ 一致性哈希



### 稳定

#### 动态超时配置

#### 熔断

失败次数超过阈值或比例超过阈值

+ 单个实例熔断

+ 服务熔断

熔断状态机：close open half_open

#### 限流

##### 单实例限流

##### 分布式限流

##### 限流算法

+ 计数器

+ 固定窗口

+ 滑动窗口

+ 漏桶

+ 令牌桶

#### 服务降级

断臂求生，弃车保帅

#### 请求重试

##### 连接重试

##### 请求重试

是否幂等

### 安全

#### 服务授权

粒度精细，配置遍历，易于观测

#### 服务鉴定

token

#### 双向加密

### 观测

#### 日志

通过日志收集系统，通过logid串联

#### 指标

趋势变化（QPS）

#### 追踪

一个请求的请求链

## 微服务网关

网关，解耦客户端和服务端，各级网关将分布式架构变成星型结构

### 设计

+ 路由转发

+ 协议转换（http<->rpc）

+ 服务注册、负载均衡、高可用

### 流量网关

全局网关

### 业务网关

和业务耦合较多的网关
