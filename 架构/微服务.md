# 微服务

关键词：RPC、IDL、多副本、容器、扩容、缩容、独立升级

## 微服务框架

微服务框架一般包含RPC框架，同时还包含其他微服务治理相关（其实rpc框架可以等同于微服务框架）

KiteX

## 微服务治理

### 路由

#### 服务注册与发现
##### 注册

服务启动时，要将服务名称、IP地址、端口以及集群、权重等服务元信息注册到注册中心。

微服务在成功启动后，会主动发起服务注册，上报注册相关的信息，包括服务名、主机、端口等必选标签，以及实例权重、集群、泳道等可选标签。收到注册并验证无误后，注册中心会回复一个成功的信号，至此注册就完成了。

常见注册中心：consul，基于raft

##### 健康检查

注册中心使用健康检查机制，在服务无法正常提供服务的时候尽快将实例从注册中心剔除。

心跳检测、进程状态探测

##### 服务发现

请求方可以提供目标服务的名称和若干元信息（机房、集群等），采取定期拉取或者订阅的模式从注册中心获得最新的注册列表。

当带 ? 的评论服务需要访问账户服务的时候，它会先向注册中心发送一个 lookup 请求，表明它想要访问 account 账户服务。注册中心接收到请求之后，会把符合条件的实例列表返回



#### 负载均衡

+ （加权）轮转调度

+ 随机调度

+ 一致性哈希
    - 解决节点数量变化带来数据迁移等麻烦
    - 一致性哈希是指将存储节点和数据都映射到一个首尾相连的哈希环上
    - 使用虚拟节点提升均衡度



### 稳定

#### 动态超时配置

#### 熔断

失败次数超过阈值或比例超过阈值

+ 单个实例熔断

+ 服务熔断

熔断状态机：close open half_open

#### 限流

+ 固定窗口

+ 滑动窗口

+ 漏桶

+ 令牌桶

+ redis分布式限流（zset）

https://juejin.cn/post/6870396751178629127

#### 服务降级

断臂求生，弃车保帅

### 安全

### 观测

#### 日志

通过日志收集系统，通过logid串联

#### 指标

趋势变化（QPS）

#### 追踪

一个请求的请求链





## 微服务网关

网关，解耦客户端和服务端，各级网关将分布式架构变成星型结构

+ 流量网关

+ 业务网关

### 设计

+ 路由转发

+ 协议转换（http<->rpc）

+ 负载均衡、高可用

